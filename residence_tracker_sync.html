<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Residencia 2026</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAAAIAAOAQAAFgAAAIlQTkcNChoKAAAADUlIRFIAAAAQAAAAEAgCAAAAkJFoNgAAANVJREFUeJyNkjEKAjEQRf/E2S3WYm3EwguId7AXPIG1tYqVeA0PYWFl4wm8iI2CoMWCNusmYxFEY5LFIU1++Pz3h9C23cXXCIG1FE1eTHuFeoz7o81wJcBxvrzt9tzKGQRn6H0iw1I5dyGIxo/oGNLc+EhpZmIhPFhfHAOQEK46SU4G9wCblwAkhLQyOP/Zwdao6RBgrd2Sir5EEyQkB0VrIPaIqIYIXBYOlS1dahUL4cOs4xjsX8r4OVFoBNi8BILRUlYKEt6V14FABL/YxxBglbotvQDpiEqFWhWREwAAAABJRU5ErkJggg==">
    <link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAIAAACyr5FlAAACvUlEQVR4nO3csYpkRRSA4VPNnWB2MVMMTAzU1/AtzMTEaMHXMTX3LXwAwVQ2MzMwGhFkpvsazA7MjPxZQ8/q99FxURQ/597q4K4fP/pk/vf2Ndtxv3m1vfnu879ebeu47+s8Kx/WOt3+/dmHn779+ofzrPhgP53W4fDnz7/8+tU3h9ev53Q67/ozczj7ivxniIMkDpI4SOIgiYMkDpI4SOIgiYMkDpI4SOIgiYMkDpI4SOIgiYMkDpI4SOIgiYMkDpI4SOIgiYMkDpI4SOIgiYMkDpI4SOIgiYMkDpI4SOIgiYMkDpI4SOIgbXOmT/W+39bDj0e2/e7SW3gB9jX7cRzFM9vVB+f/ZvZ7Z1+znfar65Ph8dj25fe/X3oPl7fPXM38cdyufvtijp4v75gcM/dxrLm6Mzme8M4xM7Pfv3Y4iqfcVh64rfyL/zlI4iCJgyQOkjhI4iCJgyQOkjhI4iCJgyQOkjhI4iCJgyQOkjhI4iCJgyQOkjhI4iCJgyQOkjhI4iCJgyQOkjhI4iCJgyQOkjhI4iCJgyQOkjhI4iCJgyQOkjhI4iCJgyQOkjhI4iCJgyQOkjhI4iCJgyQOkjhI4iCJgyQOkjhI4iCJgyQOkjhI4iCJgyQOkjhI4iCJgyQOkjhI4iCJgyQOkjhI4iCJgyQOkjhI4iCJgyQOkjhI4iCJg7TNfuktvByO4qltbZfewsuw1qxL7+Gl2W5vPFnejYzb48HweGz76c3Hl97D5e1rttN+c73dfrvmeuY4xsiYHPf2Nftxv70zOZ7wzjEzM2vWGkfxjNvKg91t5TnPFJI4SOIgiYMkDpI4SOIgiYMkDpI4SOIgiYMkDpI4SOIgiYMkDpI4SOIgiYMkDpI4SOIgiYMkDpI4SOIgiYMkDpI4SOIgiYMkDpI4SOIgiYMkDpI4SOIgiYMkDtI/9X9SFcQASJcAAAAASUVORK5CYII=">
    <link rel="icon" type="image/png" sizes="192x192" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAIAAADdvvtQAAAC8klEQVR4nO3dsYokRRzA4aq93sDlzE4MzIS71/A1TAwEowNfx9AH8C1MBR/gUjOTS1ZE2Jkpg+Wim90RfrvMqN/HxN1F8ePfXZP0/OmzLwYfWXNs+3V7s739/vWfN9vcrzWf8vpXcx7u/nrz6st33/z4lNf9YO0P88XVH7/8+u7rb1+8fLkOh+e4yxjj6pmuy/+EgEgERCIgEgGRCIhEQCQCIhEQiYBIBEQiIBIBkQiIREAkAiIREImASAREIiASAZEIiERAJAIiERCJgEgERCIgEgGRCIhEQCQCIhEQiYBIBEQiIBIBkQiIREAkAiIREImASAREIiCSbTzpN0T+O+aHH4/a1u7cS7hIa461HzbnpO360+f6ENC/2v3nnq5vDobQ47avfvj93Gu4RGuM6zne77bttzdj71n2IBPouPuArncm0AnegY5b969BNucUp7SHOYX9A/4HIhEQiYBIBEQiIBIBkQiIREAkAiIREImASAREIiASAZEIiERAJAIiERCJgEgERCIgEgGRCIhEQCQCIhEQiYBIBEQiIBIBkQiIREAkAiIREImASAREIiASAZEIiERAJAIiERCJgEgERCIgEgGRCIhEQCQCIhEQiYBIBEQiIBIBkQiIREAkAiIREImASAREIiASAZEIiERAJAIiERCJgEgERCIgEgGRCIhEQCQCIhEQiYBIBEQiIBIBkQiIREAkAiIREImASAREIiASAZEIiERAJAIi2cY69xIumc05ZZvbuZdwqeYc89xruHzb3a2n2BFrjDHH3e7KEHrc9vPbz8+9hku05tj26/Zm2303xydj7IdxdJQJdNyaY+3X3d4EOsE70APmmHPYnJOcwh62nMJO8/wiERCJgEgERCIgEgGRCIhEQCQCIhEQiYBIBEQiIBIBkQiIREAkAiIREImASAREIiASAZEIiERAJAIiERCJgEgERCIgEgGRCIhEQCQCIhEQiYBIBEQiIBIBkQiIREAkAiIREImASARE8jf8k1MvHvNjiQAAAABJRU5ErkJggg==">
    <link rel="icon" type="image/png" sizes="512x512" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIACAIAAAB7GkOtAAAHVElEQVR4nO3XMRHCABREQWCwQBUJIAAHOMAFEmIoDqKCAg3oABm/eLsKrntzx+2yHKDquV6nJ0z6vfbpCZPet/v0hGGn6QEAzBAAgCgBAIgSAIAoAQCIEgCAKAEAiBIAgCgBAIgSAIAoAQCIEgCAKAEAiBIAgCgBAIgSAIAoAQCIEgCAKAEAiBIAgCgBAIgSAIAoAQCIEgCAKAEAiBIAgCgBAIgSAIAoAQCIEgCAKAEAiBIAgCgBAIgSAIAoAQCIEgCAKAEAiBIAgCgBAIgSAIAoAQCIEgCAKAEAiBIAgCgBAIgSAIAoAQCIEgCAKAEAiBIAgCgBAIgSAIAoAQCIEgCAKAEAiBIAgCgBAIgSAIAoAQCIEgCAKAEAiBIAgCgBAIgSAIAoAQCIEgCAKAEAiBIAgCgBAIgSAIAoAQCIEgCAKAEAiBIAgCgBAIgSAIAoAQCIEgCAKAEAiBIAgCgBAIgSAIAoAQCIEgCAKAEAiBIAgCgBAIgSAIAoAQCIEgCAKAEAiBIAgCgBAIgSAIAoAQCIEgCAKAEAiBIAgCgBAIgSAIAoAQCIEgCAKAEAiBIAgCgBAIgSAIAoAQCIEgCAKAEAiBIAgCgBAIgSAIAoAQCIEgCAKAEAiBIAgCgBAIgSAIAoAQCIEgCAKAEAiDo/tu/0BpjzuU4vgDEeAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBAlAAARAkAQJQAAEQJAECUAABECQBA1Hl/LtMbYM46PQDmeAAAUQIAECUAAFECABAlAABRAgAQJQAAUQIAECUAAFECABAlAABRAgAQJQAAUQIAECUAAFECABAlAABRAgAQJQAAUQIAECUAAFECABAlAABRAgAQJQAAUQIAECUAAFECABAlAABRAgAQJQAAUQIAECUAAFECABAlAABRAgAQJQAAUQIAECUAAFECABAlAABRAgAQJQAAUQIAECUAAFECABAlAABRAgAQJQAAUQIAECUAAFECABAlAABRAgAQJQAAUQIAECUAAFECABAlAABRAgAQJQAAUQIAECUAAFECABAlAABRAgAQJQAAUQIAECUAAFECABAlAABRAgAQJQAAUQIAECUAAFECABAlAABRAgAQJQAAUQIAECUAAFECABAlAABRAgAQJQAAUQIAECUAAFECABAlAABRAgAQJQAAUQIAECUAAFECABAlAABRAgAQJQAAUQIAECUAAFECABAlAABRAgAQJQAAUQIAECUAAFECABAlAABRAgAQJQAAUX9EYA2vfA6lCgAAAABJRU5ErkJggg==">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Control Residencia">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 0;
        }

        .sync-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            padding: 10px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            font-size: 0.9em;
        }

        .sync-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4CAF50;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .sync-indicator.syncing {
            background: #FFC107;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .sync-indicator.error {
            background: #f44336;
            animation: none;
        }

        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .login-box h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .login-box p {
            margin-bottom: 30px;
            color: #666;
            line-height: 1.6;
        }

        .google-btn {
            background: #4285f4;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0 auto;
            transition: all 0.3s;
        }

        .google-btn:hover {
            background: #357ae8;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
        }

        .profile-selector {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .profile-btn {
            padding: 12px 30px;
            border: 2px solid white;
            background: transparent;
            color: white;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s;
            font-weight: 600;
        }

        .profile-btn.active {
            background: white;
            color: #667eea;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
            padding: 30px;
        }

        @media (max-width: 1024px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        .calendar-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
        }

        .year-selector {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 25px;
        }

        .year-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .year-btn:hover {
            background: #5568d3;
            transform: scale(1.05);
        }

        .year-display {
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
            justify-content: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .legend-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .legend-item.selected {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .calendar-month {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .month-header {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .day-header {
            text-align: center;
            font-weight: 600;
            color: #666;
            padding: 10px 5px;
            font-size: 0.9em;
        }

        .day-cell {
            aspect-ratio: 1;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            padding: 5px;
            min-height: 60px;
        }

        .day-cell:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10;
        }

        .day-cell:hover .edit-icon {
            opacity: 1;
        }

        .day-number {
            font-weight: 600;
            font-size: 0.95em;
            color: #333;
            margin-bottom: 3px;
        }

        .day-note {
            font-size: 0.65em;
            color: #333;
            text-align: center;
            line-height: 1.1;
            max-height: 24px;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: 700;
            margin-top: auto;
            padding-top: 2px;
        }

        .holiday-note {
            font-size: 0.6em;
            color: #d32f2f;
            text-align: center;
            line-height: 1.1;
            font-weight: 700;
            margin-top: 2px;
            max-height: 20px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .edit-icon {
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 0.75em;
            opacity: 0.4;
            transition: opacity 0.2s;
            cursor: pointer;
            z-index: 5;
        }

        .edit-icon:hover {
            opacity: 1;
            transform: scale(1.2);
        }

        .day-cell.empty {
            background: transparent;
            border: none;
            cursor: default;
        }

        .day-cell.empty:hover {
            transform: none;
            box-shadow: none;
        }

        .summary-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
        }

        .summary-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .summary-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .summary-location {
            font-weight: 600;
            font-size: 1.1em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .summary-days {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            margin: 15px 0;
        }

        .summary-label {
            text-align: center;
            color: #666;
            font-size: 0.9em;
        }

        .progress-bar {
            background: #e0e0e0;
            border-radius: 10px;
            height: 10px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s;
        }

        .monthly-breakdown {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .breakdown-title {
            font-weight: 600;
            font-size: 1.1em;
            margin-bottom: 15px;
            color: #333;
            text-align: center;
        }

        .breakdown-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }

        .breakdown-table th {
            background: #f8f9fa;
            padding: 8px 5px;
            text-align: center;
            font-weight: 600;
            color: #555;
            border-bottom: 2px solid #e0e0e0;
        }

        .breakdown-table td {
            padding: 8px 5px;
            text-align: center;
            border-bottom: 1px solid #f0f0f0;
        }

        .breakdown-table tr:hover {
            background: #f8f9fa;
        }

        .total-spain {
            background: #fff3cd;
            font-weight: 600;
        }

        .floating-counter {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #333;
            padding: 20px 30px;
            border-radius: 50%;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            z-index: 1000;
            text-align: center;
            min-width: 100px;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .floating-counter:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 32px rgba(0,0,0,0.4);
        }

        .floating-label {
            font-size: 0.9em;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .floating-number {
            font-size: 2.5em;
            font-weight: bold;
            line-height: 1;
        }

        @media (max-width: 768px) {
            .floating-counter {
                bottom: 20px;
                right: 20px;
                padding: 15px 20px;
                min-width: 80px;
                min-height: 80px;
            }
            
            .floating-number {
                font-size: 2em;
            }

            body {
                padding: 10px;
            }

            .header {
                padding: 20px 15px;
            }

            .header h1 {
                font-size: 1.5em;
            }

            .profile-btn {
                padding: 10px 20px;
                font-size: 1em;
            }

            .dashboard {
                grid-template-columns: 1fr;
                padding: 15px;
                gap: 20px;
            }

            .calendar-section, .summary-section {
                padding: 15px;
            }

            .legend {
                gap: 8px;
            }

            .legend-item {
                padding: 6px 12px;
                font-size: 0.9em;
            }

            .year-selector {
                margin-bottom: 15px;
            }

            .year-display {
                font-size: 1.5em;
            }

            .calendar-month {
                padding: 15px;
            }

            .month-header {
                font-size: 1.1em;
            }

            .day-cell {
                min-height: 50px;
                padding: 3px;
            }

            .day-number {
                font-size: 0.85em;
            }

            .day-note, .holiday-note {
                font-size: 0.55em;
                max-height: 18px;
            }

            .summary-card {
                padding: 15px;
            }

            .summary-days {
                font-size: 1.8em;
            }

            .breakdown-table {
                font-size: 0.75em;
            }

            .breakdown-table th,
            .breakdown-table td {
                padding: 6px 3px;
            }

            .modal-content {
                padding: 20px;
                width: 95%;
            }

            .action-btn {
                padding: 10px 20px;
                font-size: 0.9em;
            }
        }

        /* Extra small phones */
        @media (max-width: 375px) {
            .header h1 {
                font-size: 1.3em;
            }

            .profile-btn {
                padding: 8px 15px;
                font-size: 0.9em;
            }

            .legend-item {
                padding: 5px 10px;
                font-size: 0.85em;
            }

            .day-cell {
                min-height: 45px;
            }

            .calendar-grid {
                gap: 5px;
            }

            .floating-counter {
                min-width: 70px;
                min-height: 70px;
                padding: 12px 15px;
            }

            .floating-number {
                font-size: 1.8em;
            }

            .floating-label {
                font-size: 0.8em;
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }

        .modal-label {
            font-weight: 600;
            margin-bottom: 10px;
            color: #555;
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            margin-bottom: 20px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .modal-btn.primary {
            background: #667eea;
            color: white;
        }

        .modal-btn.primary:hover {
            background: #5568d3;
        }

        .modal-btn.secondary {
            background: #e0e0e0;
            color: #333;
        }

        .modal-btn.secondary:hover {
            background: #d0d0d0;
        }

        .actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .action-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
            background: #667eea;
            color: white;
        }

        .action-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .color-MAD { background-color: #FFEB3B; }
        .color-AND { background-color: #2196F3; }
        .color-IT { background-color: #F44336; }
        .color-FR { background-color: #4CAF50; }
        .color-OTHER { background-color: #9C27B0; }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="login-overlay" id="loginOverlay">
        <div class="login-box">
            <h2>üîê Iniciar Sesi√≥n</h2>
            <p>Para sincronizar tus datos en la nube, necesitas conectar tu cuenta de Google Drive.</p>
            <button class="google-btn" onclick="signIn()">
                <svg width="20" height="20" viewBox="0 0 48 48">
                    <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
                    <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
                    <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
                    <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
                </svg>
                Conectar con Google
            </button>
        </div>
    </div>

    <div class="container hidden" id="mainApp">
        <div class="header">
            <h1>Control de Residencia</h1>
            <div class="sync-status">
                <div class="sync-indicator" id="syncIndicator"></div>
                <span id="syncStatus">Sincronizado con Google Drive</span>
            </div>
            <div class="profile-selector">
                <button class="profile-btn active" onclick="switchProfile('RG')">Ricardo</button>
                <button class="profile-btn" onclick="switchProfile('SB')">Sylvia</button>
            </div>
        </div>

        <div class="dashboard">
            <div class="calendar-section">
                <div class="year-selector">
                    <button class="year-btn" onclick="changeYear(-1)">‚Äπ</button>
                    <div class="year-display" id="yearDisplay">2026</div>
                    <button class="year-btn" onclick="changeYear(1)">‚Ä∫</button>
                </div>

                <div class="legend">
                    <div class="legend-item selected" onclick="selectLocation('MAD')" data-location="MAD">
                        <span>üü° Madrid</span>
                    </div>
                    <div class="legend-item" onclick="selectLocation('AND')" data-location="AND">
                        <span>üîµ Andratx</span>
                    </div>
                    <div class="legend-item" onclick="selectLocation('IT')" data-location="IT">
                        <span>üî¥ Italia</span>
                    </div>
                    <div class="legend-item" onclick="selectLocation('FR')" data-location="FR">
                        <span>üü¢ Francia</span>
                    </div>
                    <div class="legend-item" onclick="selectLocation('OTHER')" data-location="OTHER">
                        <span>üü£ Other</span>
                    </div>
                </div>

                <div id="calendar"></div>
            </div>

            <div class="summary-section">
                <div class="summary-title">üìä Resumen de D√≠as</div>
                <div id="summary"></div>
                <div class="monthly-breakdown">
                    <div class="breakdown-title">üìÖ Resumen Mensual</div>
                    <div id="monthlyTable"></div>
                </div>
                <div class="actions">
                    <button class="action-btn" onclick="exportData()">üíæ Exportar</button>
                    <button class="action-btn" onclick="importData()">üì• Importar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="floating-counter" id="floatingCounter">
        <div class="floating-label">üá™üá∏ Espa√±a</div>
        <div class="floating-number" id="floatingNumber">0</div>
    </div>

    <div class="modal" id="noteModal">
        <div class="modal-content">
            <div class="modal-header" id="modalHeader">Editar D√≠a</div>
            <div class="modal-label">Nota / Evento:</div>
            <textarea class="modal-input" id="noteInput" rows="4" placeholder="Ej: Reuni√≥n con cliente, Vuelo a Madrid..."></textarea>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeModal()">Cancelar</button>
                <button class="modal-btn primary" onclick="saveNote()">Guardar</button>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" style="display:none" accept=".json" onchange="handleFileImport(event)">

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        const LOCATIONS = {
            MAD: { name: 'Madrid', color: '#FFEB3B', emoji: 'üü°' },
            AND: { name: 'Andratx', color: '#2196F3', emoji: 'üîµ' },
            IT: { name: 'Italia', color: '#F44336', emoji: 'üî¥' },
            FR: { name: 'Francia', color: '#4CAF50', emoji: 'üü¢' },
            OTHER: { name: 'Other', color: '#9C27B0', emoji: 'üü£' }
        };

        const MONTHS = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                       'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        
        const DAYS = ['L', 'M', 'X', 'J', 'V', 'S', 'D'];

        // IMPORTANTE: Client ID configurado
        const CLIENT_ID = '62569860135-87ahagt2aflno2e0o022l44iovnk2de4.apps.googleusercontent.com';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        let currentYear = 2026;
        let currentProfile = 'RG';
        let selectedLocation = 'MAD';
        let currentEditDay = null;
        let tokenClient;
        let accessToken = null;
        let fileId = null;

        let data = {
            RG: {},
            SB: {}
        };

        // Calcular festivos
        function getEasterDate(year) {
            const f = Math.floor,
                G = year % 19,
                C = f(year / 100),
                H = (C - f(C / 4) - f((8 * C + 13) / 25) + 19 * G + 15) % 30,
                I = H - f(H / 28) * (1 - f(29 / (H + 1)) * f((21 - G) / 11)),
                J = (year + f(year / 4) + I + 2 - C + f(C / 4)) % 7,
                L = I - J,
                month = 3 + f((L + 40) / 44),
                day = L + 28 - 31 * f(month / 4);
            return new Date(year, month - 1, day);
        }

        function getSpainHolidays(year) {
            const easter = getEasterDate(year);
            const holidays = {};
            
            // Festivos fijos Espa√±a
            holidays[`${year}-01-01`] = 'A√±o Nuevo';
            holidays[`${year}-01-06`] = 'Epifan√≠a del Se√±or';
            holidays[`${year}-05-01`] = 'Fiesta del Trabajo';
            holidays[`${year}-08-15`] = 'Asunci√≥n de la Virgen';
            holidays[`${year}-10-12`] = 'Fiesta Nacional de Espa√±a';
            holidays[`${year}-11-01`] = 'Todos los Santos';
            holidays[`${year}-12-06`] = 'D√≠a de la Constituci√≥n';
            holidays[`${year}-12-08`] = 'Inmaculada Concepci√≥n';
            holidays[`${year}-12-25`] = 'Navidad';
            
            // Festivos m√≥viles (basados en Semana Santa)
            const juevesSanto = new Date(easter);
            juevesSanto.setDate(easter.getDate() - 3);
            holidays[`${year}-${String(juevesSanto.getMonth() + 1).padStart(2, '0')}-${String(juevesSanto.getDate()).padStart(2, '0')}`] = 'Jueves Santo';
            
            const viernesSanto = new Date(easter);
            viernesSanto.setDate(easter.getDate() - 2);
            holidays[`${year}-${String(viernesSanto.getMonth() + 1).padStart(2, '0')}-${String(viernesSanto.getDate()).padStart(2, '0')}`] = 'Viernes Santo';
            
            return holidays;
        }

        function getItalyHolidays(year) {
            const easter = getEasterDate(year);
            const holidays = {};
            
            // Festivos fijos Italia
            holidays[`${year}-01-01`] = 'Capodanno';
            holidays[`${year}-01-06`] = 'Epifania';
            holidays[`${year}-04-25`] = 'Festa della Liberazione';
            holidays[`${year}-05-01`] = 'Festa del Lavoro';
            holidays[`${year}-06-02`] = 'Festa della Repubblica';
            holidays[`${year}-08-15`] = 'Assunzione di Maria';
            holidays[`${year}-11-01`] = 'Tutti i Santi';
            holidays[`${year}-12-08`] = 'Immacolata Concezione';
            holidays[`${year}-12-25`] = 'Natale';
            holidays[`${year}-12-26`] = 'Santo Stefano';
            
            // Lunes de Pascua
            const lunesPascua = new Date(easter);
            lunesPascua.setDate(easter.getDate() + 1);
            holidays[`${year}-${String(lunesPascua.getMonth() + 1).padStart(2, '0')}-${String(lunesPascua.getDate()).padStart(2, '0')}`] = 'Luned√¨ dell\'Angelo';
            
            return holidays;
        }

        function getHolidayForDay(year, month, day) {
            const key = getDayKey(year, month, day);
            const spainHolidays = getSpainHolidays(year);
            const italyHolidays = getItalyHolidays(year);
            
            const holidays = [];
            if (spainHolidays[key]) {
                holidays.push(`üá™üá∏ ${spainHolidays[key]}`);
            }
            if (italyHolidays[key]) {
                holidays.push(`üáÆüáπ ${italyHolidays[key]}`);
            }
            
            return holidays.length > 0 ? holidays.join(' | ') : null;
        }

        // Inicializar Google Identity Services
        function initGoogleAuth() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: handleAuthResponse,
            });
        }

        function signIn() {
            tokenClient.requestAccessToken();
        }

        function handleAuthResponse(response) {
            if (response.error) {
                console.error('Error en autenticaci√≥n:', response);
                updateSyncStatus('error', 'Error al conectar');
                return;
            }

            accessToken = response.access_token;
            document.getElementById('loginOverlay').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            loadDataFromDrive();
        }

        async function loadDataFromDrive() {
            updateSyncStatus('syncing', 'Cargando datos...');
            
            try {
                // Buscar el archivo en Drive
                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files?q=name='residence_data.json'&spaces=appDataFolder`,
                    {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    }
                );

                const result = await response.json();
                
                if (result.files && result.files.length > 0) {
                    fileId = result.files[0].id;
                    
                    // Descargar el archivo
                    const fileResponse = await fetch(
                        `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
                        {
                            headers: {
                                'Authorization': `Bearer ${accessToken}`
                            }
                        }
                    );
                    
                    const fileData = await fileResponse.json();
                    data = fileData;
                } else {
                    // Crear archivo nuevo si no existe
                    await saveDataToDrive();
                }
                
                renderCalendar();
                updateSummary();
                updateSyncStatus('synced', 'Sincronizado');
                
                // Sincronizar cada 30 segundos
                setInterval(syncData, 30000);
                
            } catch (error) {
                console.error('Error al cargar datos:', error);
                updateSyncStatus('error', 'Error al cargar');
            }
        }

        async function saveDataToDrive() {
            updateSyncStatus('syncing', 'Guardando...');
            
            try {
                const metadata = {
                    name: 'residence_data.json',
                    mimeType: 'application/json',
                    parents: ['appDataFolder']
                };

                const fileContent = JSON.stringify(data);
                const blob = new Blob([fileContent], { type: 'application/json' });

                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', blob);

                let url = 'https://www.googleapis.com/upload/drive/v3/files';
                let method = 'POST';

                if (fileId) {
                    url = `https://www.googleapis.com/upload/drive/v3/files/${fileId}`;
                    method = 'PATCH';
                }

                const response = await fetch(url + '?uploadType=multipart', {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: form
                });

                const result = await response.json();
                
                if (!fileId) {
                    fileId = result.id;
                }
                
                updateSyncStatus('synced', 'Sincronizado');
            } catch (error) {
                console.error('Error al guardar:', error);
                updateSyncStatus('error', 'Error al guardar');
            }
        }

        async function syncData() {
            if (!accessToken) return;
            
            try {
                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
                    {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    }
                );
                
                const cloudData = await response.json();
                
                // Comparar y actualizar si hay cambios
                if (JSON.stringify(cloudData) !== JSON.stringify(data)) {
                    data = cloudData;
                    renderCalendar();
                    updateSummary();
                }
                
                updateSyncStatus('synced', 'Sincronizado');
            } catch (error) {
                console.error('Error en sincronizaci√≥n:', error);
            }
        }

        function updateSyncStatus(status, text) {
            const indicator = document.getElementById('syncIndicator');
            const statusText = document.getElementById('syncStatus');
            
            indicator.className = 'sync-indicator';
            
            if (status === 'syncing') {
                indicator.classList.add('syncing');
            } else if (status === 'error') {
                indicator.classList.add('error');
            }
            
            statusText.textContent = text;
        }

        function switchProfile(profile) {
            currentProfile = profile;
            document.querySelectorAll('.profile-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            renderCalendar();
            updateSummary();
        }

        function changeYear(delta) {
            currentYear += delta;
            document.getElementById('yearDisplay').textContent = currentYear;
            renderCalendar();
            updateSummary();
        }

        function selectLocation(location) {
            selectedLocation = location;
            document.querySelectorAll('.legend-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.target.closest('.legend-item').classList.add('selected');
        }

        function getDayKey(year, month, day) {
            return `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        }

        function getDayData(year, month, day) {
            const key = getDayKey(year, month, day);
            if (!data[currentProfile][key]) {
                data[currentProfile][key] = { location: null, note: '' };
            }
            return data[currentProfile][key];
        }

        function renderCalendar() {
            const calendar = document.getElementById('calendar');
            calendar.innerHTML = '';

            for (let month = 0; month < 12; month++) {
                const monthDiv = document.createElement('div');
                monthDiv.className = 'calendar-month';
                
                const header = document.createElement('div');
                header.className = 'month-header';
                header.textContent = MONTHS[month];
                monthDiv.appendChild(header);

                const grid = document.createElement('div');
                grid.className = 'calendar-grid';

                DAYS.forEach(day => {
                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'day-header';
                    dayHeader.textContent = day;
                    grid.appendChild(dayHeader);
                });

                const firstDay = new Date(currentYear, month, 1).getDay();
                const daysInMonth = new Date(currentYear, month + 1, 0).getDate();
                const startDay = firstDay === 0 ? 6 : firstDay - 1;

                for (let i = 0; i < startDay; i++) {
                    const emptyCell = document.createElement('div');
                    emptyCell.className = 'day-cell empty';
                    grid.appendChild(emptyCell);
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const dayCell = document.createElement('div');
                    dayCell.className = 'day-cell';
                    
                    const dayData = getDayData(currentYear, month, day);
                    if (dayData.location) {
                        dayCell.classList.add(`color-${dayData.location}`);
                    }

                    const editIcon = document.createElement('div');
                    editIcon.className = 'edit-icon';
                    editIcon.textContent = 'üìù';
                    dayCell.appendChild(editIcon);

                    const dayNumber = document.createElement('div');
                    dayNumber.className = 'day-number';
                    dayNumber.textContent = day;
                    dayCell.appendChild(dayNumber);

                    // Festivo autom√°tico
                    const holiday = getHolidayForDay(currentYear, month, day);
                    if (holiday) {
                        const holidayNote = document.createElement('div');
                        holidayNote.className = 'holiday-note';
                        holidayNote.textContent = holiday;
                        dayCell.appendChild(holidayNote);
                    }

                    // Nota del usuario
                    if (dayData.note) {
                        const note = document.createElement('div');
                        note.className = 'day-note';
                        note.textContent = dayData.note;
                        dayCell.appendChild(note);
                    }

                    dayCell.onclick = (e) => handleDayClick(currentYear, month, day, e);
                    grid.appendChild(dayCell);
                }

                monthDiv.appendChild(grid);
                calendar.appendChild(monthDiv);
            }
        }

        function handleDayClick(year, month, day, e) {
            e.stopPropagation();
            
            if (e.target.classList.contains('edit-icon')) {
                openNoteModal(year, month, day);
                return;
            }
            
            const dayData = getDayData(year, month, day);
            
            if (dayData.location === selectedLocation) {
                dayData.location = null;
            } else {
                dayData.location = selectedLocation;
            }
            
            saveDataToDrive();
            renderCalendar();
            updateSummary();
        }

        function openNoteModal(year, month, day) {
            currentEditDay = { year, month, day };
            const dayData = getDayData(year, month, day);
            const dateStr = `${day} de ${MONTHS[month]} ${year}`;
            
            document.getElementById('modalHeader').textContent = `üìù ${dateStr}`;
            document.getElementById('noteInput').value = dayData.note || '';
            document.getElementById('noteModal').classList.add('active');
            document.getElementById('noteInput').focus();
        }

        function closeModal() {
            document.getElementById('noteModal').classList.remove('active');
            currentEditDay = null;
        }

        function saveNote() {
            if (!currentEditDay) return;
            
            const { year, month, day } = currentEditDay;
            const note = document.getElementById('noteInput').value;
            const key = getDayKey(year, month, day);
            
            if (!data[currentProfile][key]) {
                data[currentProfile][key] = { location: null, note: '' };
            }
            data[currentProfile][key].note = note;
            
            saveDataToDrive();
            closeModal();
            renderCalendar();
        }

        function updateSummary() {
            const summary = document.getElementById('summary');
            summary.innerHTML = '';

            const counts = {};
            const monthlyCounts = {};
            
            Object.keys(LOCATIONS).forEach(loc => counts[loc] = 0);
            
            for (let m = 0; m < 12; m++) {
                monthlyCounts[m] = {};
                Object.keys(LOCATIONS).forEach(loc => monthlyCounts[m][loc] = 0);
            }

            Object.keys(data[currentProfile]).forEach(key => {
                if (key.startsWith(currentYear.toString())) {
                    const dayData = data[currentProfile][key];
                    if (dayData.location) {
                        counts[dayData.location]++;
                        
                        const [year, month, day] = key.split('-').map(Number);
                        monthlyCounts[month - 1][dayData.location]++;
                    }
                }
            });

            const spainDays = counts.MAD + counts.AND;
            const total = Object.values(counts).reduce((a, b) => a + b, 0);

            const spainCard = document.createElement('div');
            spainCard.className = 'summary-card';
            spainCard.style.background = 'linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%)';
            spainCard.innerHTML = `
                <div class="summary-location">
                    üá™üá∏ Espa√±a
                </div>
                <div class="summary-days">${spainDays}</div>
                <div class="summary-label">d√≠as en el a√±o</div>
            `;
            summary.appendChild(spainCard);

            Object.keys(LOCATIONS).forEach(loc => {
                const card = document.createElement('div');
                card.className = 'summary-card';

                const locationHeader = document.createElement('div');
                locationHeader.className = 'summary-location';
                locationHeader.innerHTML = `
                    ${LOCATIONS[loc].emoji} ${LOCATIONS[loc].name}
                `;
                card.appendChild(locationHeader);

                const days = document.createElement('div');
                days.className = 'summary-days';
                days.textContent = counts[loc];
                card.appendChild(days);

                const label = document.createElement('div');
                label.className = 'summary-label';
                label.textContent = 'd√≠as en el a√±o';
                card.appendChild(label);

                if (total > 0) {
                    const progressBar = document.createElement('div');
                    progressBar.className = 'progress-bar';
                    const progressFill = document.createElement('div');
                    progressFill.className = 'progress-fill';
                    progressFill.style.width = `${(counts[loc] / total) * 100}%`;
                    progressFill.style.backgroundColor = LOCATIONS[loc].color;
                    progressBar.appendChild(progressFill);
                    card.appendChild(progressBar);
                }

                summary.appendChild(card);
            });

            updateMonthlyTable(monthlyCounts);
        }

        function updateMonthlyTable(monthlyCounts) {
            const monthlyTable = document.getElementById('monthlyTable');
            
            let tableHTML = '<table class="breakdown-table"><thead><tr>';
            tableHTML += '<th>Mes</th><th>MAD</th><th>AND</th><th>IT</th><th>FR</th><th>OTH</th><th class="total-spain">ESP</th><th>TOT</th>';
            tableHTML += '</tr></thead><tbody>';

            let yearTotals = { MAD: 0, AND: 0, IT: 0, FR: 0, OTHER: 0 };

            for (let m = 0; m < 12; m++) {
                const mad = monthlyCounts[m].MAD || 0;
                const and = monthlyCounts[m].AND || 0;
                const it = monthlyCounts[m].IT || 0;
                const fr = monthlyCounts[m].FR || 0;
                const other = monthlyCounts[m].OTHER || 0;
                const spain = mad + and;
                const total = mad + and + it + fr + other;

                yearTotals.MAD += mad;
                yearTotals.AND += and;
                yearTotals.IT += it;
                yearTotals.FR += fr;
                yearTotals.OTHER += other;

                tableHTML += `<tr>
                    <td><strong>${MONTHS[m].substring(0, 3)}</strong></td>
                    <td>${mad}</td>
                    <td>${and}</td>
                    <td>${it}</td>
                    <td>${fr}</td>
                    <td>${other}</td>
                    <td class="total-spain">${spain}</td>
                    <td><strong>${total}</strong></td>
                </tr>`;
            }

            const yearSpain = yearTotals.MAD + yearTotals.AND;
            const yearTotal = Object.values(yearTotals).reduce((a, b) => a + b, 0);

            tableHTML += `<tr style="background: #e9ecef; font-weight: bold;">
                <td>TOTAL</td>
                <td>${yearTotals.MAD}</td>
                <td>${yearTotals.AND}</td>
                <td>${yearTotals.IT}</td>
                <td>${yearTotals.FR}</td>
                <td>${yearTotals.OTHER}</td>
                <td class="total-spain">${yearSpain}</td>
                <td><strong>${yearTotal}</strong></td>
            </tr>`;

            tableHTML += '</tbody></table>';
            monthlyTable.innerHTML = tableHTML;
            
            document.getElementById('floatingNumber').textContent = yearSpain;
        }

        function exportData() {
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `residencia_${currentYear}_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function importData() {
            document.getElementById('fileInput').click();
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (confirm('¬øEst√°s seguro de que quieres importar estos datos? Esto sobrescribir√° los datos actuales.')) {
                        data = importedData;
                        saveDataToDrive();
                        renderCalendar();
                        updateSummary();
                        alert('¬°Datos importados correctamente!');
                    }
                } catch (error) {
                    alert('Error al importar el archivo. Aseg√∫rate de que sea un archivo JSON v√°lido.');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        window.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // Inicializar cuando se carga Google Identity Services
        window.onload = function() {
            initGoogleAuth();
        };
    </script>
</body>
</html>