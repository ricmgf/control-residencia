<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Calendar 2026</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAAAIAAOAQAAFgAAAIlQTkcNChoKAAAADUlIRFIAAAAQAAAAEAgCAAAAkJFoNgAAANVJREFUeJyNkjEKAjEQRf/E2S3WYm3EwguId7AXPIG1tYqVeA0PYWFl4wm8iI2CoMWCNusmYxFEY5LFIU1++Pz3h9C23cXXCIG1FE1eTHuFeoz7o81wJcBxvrzt9tzKGQRn6H0iw1I5dyGIxo/oGNLc+EhpZmIhPFhfHAOQEK46SU4G9wCblwAkhLQyOP/Zwdao6RBgrd2Sir5EEyQkB0VrIPaIqIYIXBYOlS1dahUL4cOs4xjsX8r4OVFoBNi8BILRUlYKEt6V14FABL/YxxBglbotvQDpiEqFWhWREwAAAABJRU5ErkJggg==">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-bg: #f8f9fa;
            --text-main: #2d3436;
            --white: #ffffff;
            --shadow: 0 10px 30px rgba(0,0,0,0.1);
            --madrid: #fdcb6e;
            --andratx: #0984e3;
            --italia: #d63031;
            --francia: #00b894;
            --other: #a29bfe;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--secondary-bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        .header {
            background: var(--primary-gradient);
            padding: 40px 20px;
            text-align: center;
            color: var(--white);
            box-shadow: var(--shadow);
            position: relative;
        }

        .header h1 { margin: 0; font-size: 2.5em; font-weight: 700; letter-spacing: -1px; }

        .status-bar {
            background: rgba(255,255,255,0.15);
            padding: 10px 20px;
            border-radius: 50px;
            display: inline-block;
            margin-top: 15px;
            font-size: 0.9em;
            backdrop-filter: blur(5px);
        }

        .status-dot { height: 8px; width: 8px; background: #55efc4; border-radius: 50%; display: inline-block; margin-right: 8px; box-shadow: 0 0 10px #55efc4; }

        .user-selector { display: flex; justify-content: center; gap: 20px; margin-top: 30px; }
        .user-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid var(--white);
            padding: 12px 35px;
            border-radius: 30px;
            color: var(--white);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .user-btn.active { background: var(--white); color: #764ba2; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }

        .legend {
            position: -webkit-sticky;
            position: sticky;
            top: 20px;
            z-index: 100;
            background: var(--white);
            margin: -30px auto 30px;
            padding: 20px;
            border-radius: 20px;
            width: 90%;
            max-width: 800px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            box-shadow: var(--shadow);
        }

        .color-item {
            display: flex; align-items: center; gap: 10px; padding: 8px 15px;
            border-radius: 15px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;
        }
        .color-item.selected { border-color: #6c5ce7; background: #f0f0ff; }
        .dot { width: 18px; height: 18px; border-radius: 50%; border: 2px solid rgba(0,0,0,0.1); }

        .action-btns { margin-left: 20px; display: flex; gap: 10px; border-left: 1px solid #eee; padding-left: 20px; }
        .btn-icon { background: #6c5ce7; color: white; border: none; padding: 10px 20px; border-radius: 12px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; }

        .year-nav { display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 30px; }
        .nav-btn { background: #6c5ce7; color: white; border: none; width: 40px; height: 40px; border-radius: 12px; cursor: pointer; }

        .calendar-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 30px; padding: 20px; max-width: 1400px; margin: 0 auto; }
        .month-card { background: var(--white); border-radius: 25px; padding: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        .month-title { text-align: center; font-size: 1.4em; font-weight: 700; color: var(--text-main); margin-bottom: 20px; }
        .days-header { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-weight: 700; font-size: 0.8em; color: #b2bec3; margin-bottom: 10px; }
        .days-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .day { aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center; border-radius: 12px; font-weight: 600; font-size: 0.9em; cursor: pointer; border: 1px solid #f1f2f6; position: relative; }
        .day:hover { background-color: #f1f2f6; }
        .day.other-month { opacity: 0; pointer-events: none; }

        .summary-badge {
            position: fixed; bottom: 30px; right: 30px; background: var(--madrid); padding: 20px; border-radius: 50%; width: 60px; height: 60px; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 10px 20px rgba(253, 203, 110, 0.4); font-weight: 700; z-index: 1000;
        }
        .summary-label { font-size: 0.6em; text-transform: uppercase; text-align: center; }
        .summary-val { font-size: 1.4em; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Control de Residencia</h1>
        <div class="status-bar"><span class="status-dot"></span><span id="syncStatusText">Esperando conexi√≥n...</span></div>
        <div class="user-selector">
            <button class="user-btn active" id="btnRicardo" onclick="setUser('Ricardo')">Ricardo</button>
            <button class="user-btn" id="btnSylvia" onclick="setUser('Sylvia')">Sylvia</button>
        </div>
    </div>

    <div class="legend" id="legendSelector">
        <div class="color-item selected" onclick="selectColor('--madrid', this)"><div class="dot" style="background: var(--madrid)"></div><span>Madrid</span></div>
        <div class="color-item" onclick="selectColor('--andratx', this)"><div class="dot" style="background: var(--andratx)"></div><span>Andratx</span></div>
        <div class="color-item" onclick="selectColor('--italia', this)"><div class="dot" style="background: var(--italia)"></div><span>Italia</span></div>
        <div class="color-item" onclick="selectColor('--francia', this)"><div class="dot" style="background: var(--francia)"></div><span>Francia</span></div>
        <div class="color-item" onclick="selectColor('--other', this)"><div class="dot" style="background: var(--other)"></div><span>Other</span></div>
        <div class="action-btns">
            <button class="btn-icon" onclick="saveToLocal()">üíæ Guardar Local</button>
            <button class="btn-icon" style="background: #4285F4" onclick="handleGoogleAuth()">üîë Conectar Google</button>
        </div>
    </div>

    <div class="year-nav">
        <button class="nav-btn" onclick="changeYear(-1)">‚ùÆ</button>
        <h2 id="yearDisplay">2026</h2>
        <button class="nav-btn" onclick="changeYear(1)">‚ùØ</button>
    </div>

    <div id="calendarContainer" class="calendar-grid"></div>

    <div class="summary-badge">
        <span class="summary-label">üá™üá∏ Espa√±a</span>
        <span class="summary-val" id="totalSpainCount">0</span>
    </div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>

    <script>
        const CLIENT_ID = '62569860135-87ahagt2aflno2e0o022l44iovnk2de4.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/calendar.events.readonly';

        let tokenClient;
        let currentYear = 2026;
        let currentUser = 'Ricardo';
        let selectedColorVar = '--madrid';
        
        // Estructura de datos con Timestamp
        let travelData = JSON.parse(localStorage.getItem('residence_tracker_v2')) || {
            updatedAt: 0,
            days: {}
        };

        function loadGoogleScripts() {
            gapi.load('client', async () => {
                await gapi.client.init({
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest'],
                });
                document.getElementById('syncStatusText').innerText = "Listo";
            });

            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (resp) => {
                    if (resp.error) return;
                    document.getElementById('syncStatusText').innerText = "‚úÖ Sincronizado";
                },
            });
        }

        function handleGoogleAuth() {
            tokenClient.requestAccessToken({prompt: 'consent'});
        }

        function selectColor(colorVar, element) {
            selectedColorVar = colorVar;
            document.querySelectorAll('.color-item').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
        }

        function setUser(user) {
            currentUser = user;
            document.getElementById('btnRicardo').classList.toggle('active', user === 'Ricardo');
            document.getElementById('btnSylvia').classList.toggle('active', user === 'Sylvia');
            renderCalendar();
        }

        function changeYear(delta) {
            currentYear += delta;
            document.getElementById('yearDisplay').innerText = currentYear;
            renderCalendar();
        }

        function renderCalendar() {
            const container = document.getElementById('calendarContainer');
            container.innerHTML = '';
            const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

            months.forEach((month, index) => {
                const card = document.createElement('div');
                card.className = 'month-card';
                card.innerHTML = `<div class="month-title">${month}</div>`;
                
                const header = document.createElement('div');
                header.className = 'days-header';
                ['L','M','X','J','V','S','D'].forEach(d => header.innerHTML += `<div>${d}</div>`);
                card.appendChild(header);

                const grid = document.createElement('div');
                grid.className = 'days-grid';
                
                const firstDay = new Date(currentYear, index, 1).getDay();
                const offset = firstDay === 0 ? 6 : firstDay - 1;
                const daysInMonth = new Date(currentYear, index + 1, 0).getDate();

                for(let i=0; i<offset; i++) grid.innerHTML += `<div class="day other-month"></div>`;

                for(let d=1; d<=daysInMonth; d++) {
                    const dateKey = `${currentYear}-${index+1}-${d}-${currentUser}`;
                    const day = document.createElement('div');
                    day.className = 'day';
                    day.innerText = d;
                    
                    if(travelData.days[dateKey]) {
                        day.style.background = `var(${travelData.days[dateKey]})`;
                        day.style.color = 'white';
                    }

                    day.onclick = () => {
                        if(travelData.days[dateKey]) {
                            delete travelData.days[dateKey];
                            day.style.background = '';
                            day.style.color = '';
                        } else {
                            travelData.days[dateKey] = selectedColorVar;
                            day.style.background = `var(${selectedColorVar})`;
                            day.style.color = 'white';
                        }
                        travelData.updatedAt = Date.now();
                        updateSummary();
                    };
                    grid.appendChild(day);
                }
                card.appendChild(grid);
                container.appendChild(card);
            });
            updateSummary();
        }

        function updateSummary() {
            let spainCount = 0;
            const spainColors = ['--madrid', '--andratx'];
            
            Object.keys(travelData.days).forEach(key => {
                if(key.endsWith(currentUser) && key.startsWith(currentYear)) {
                    if(spainColors.includes(travelData.days[key])) spainCount++;
                }
            });
            document.getElementById('totalSpainCount').innerText = spainCount;
        }

        function saveToLocal() {
            travelData.updatedAt = Date.now();
            localStorage.setItem('residence_tracker_v2', JSON.stringify(travelData));
            alert("Guardado con √©xito");
        }

        window.onload = () => {
            loadGoogleScripts();
            renderCalendar();
        };
    </script>
</body>
</html>
