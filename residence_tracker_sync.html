// ... dentro de result.items.forEach(event => { ...

if (hasKeyword && event.start) {
    let eventDate = event.start.date || event.start.dateTime.split('T')[0];
    
    // 1. Asegurar que el perfil y la fecha existen (Protección extra)
    if (!data[currentProfile]) data[currentProfile] = {};
    if (!data[currentProfile][eventDate]) {
        data[currentProfile][eventDate] = { location: null, note: '' };
    }

    const currentNote = data[currentProfile][eventDate].note || '';
    const currentNoteLower = currentNote.toLowerCase();
    
    // 2. Comprobar duplicados de forma más inteligente
    if (!currentNoteLower.includes(summaryLower)) {
        // CORRECCIÓN: Usamos '\n' (una sola barra) para el salto de línea real
        data[currentProfile][eventDate].note = (currentNote ? currentNote + '\n' + summary : summary).trim();
        eventsImported++;
        console.log(`✅ ¡IMPORTADO!: "${summary}" en ${eventDate}`);
    } else {
        console.log(`⏭️ Omitido (ya existe): "${summary}"`);
    }
}
